{% import "macros.html" as macro %}
{% extends "layout.html" %}
{% block main %}

<h2>{{ case['title'] }}</h2>

{% if who['kind'] in ['OPR', 'USR', 'MNR'] %}

<div class="Button"><a href='/cases/{{ case['_id'] }}/edit'>Editar</a></div>

{% endif %}

{{ case['overview'] | safe }}

<p>
<strong>Fuente del requerimiento:</strong>
{% if case['requester'] == '0' %}
    Interno
{% else %}
    Externo
{% endif %}
</p>

<ul class="tab">
    <li><a href="#updates" class="tablinks" onclick="openTab(event, 'updates')">Actualizaciones</a></li>
    <li><a href="#requests" class="tablinks" onclick="openTab(event, 'requests')">Peticiones</a></li>
    <li><a href="#complains" class="tablinks" onclick="openTab(event, 'complains')">Denuncias</a></li>
    <li><a href="#advises" class="tablinks" onclick="openTab(event, 'advises')">Asesoría</a></li>
    <li><a href="#docs" class="tablinks" onclick="openTab(event, 'docs')">Documentos</a></li>
</ul>

<div id="updates" class="tabcontent">

    {% if who['kind'] in ['OPR', 'USR', 'MNR'] %}
        <form action='/updates/new/' method="post">
            <input type="hidden" name="source" value="case">
            <input type="hidden" name="source_id" 
                   value="{{ case['_id'] }}">
            <input class="Inline" type="date" size="8" 
                   name="date" placeholder="Fecha">
            <textarea class="Inline" name="detail" 
                      cols="60" rows="10" placeholder="Detalle"></textarea>
            <button>Actualizar</button>
        </form>
    {% endif %}

    <table>
        {% for update in updates %}
        <tr class="ListItem">
            <td>{{ update['date'] }}</td>
            <td>{{ update['detail'] | safe }}</td>
        </tr>
        {% endfor %}
    </table>
</div>

<div id="requests" class="tabcontent">
    
    {% if who['kind'] in ['OPR', 'USR', 'MNR'] %}
        <div class="Button"><a href="/requests/new/?case_id={{ case['_id'] }}">Nueva...</a></div>
    {% endif %}
    {{ macro.listItems('requests', requests) }}
</div>

<div id="complains" class="tabcontent">
    {% if who['kind'] in ['OPR', 'USR', 'MNR'] %}
        <div class="Button"><a href="/complains/new/?case_id={{ case['_id'] }}">Nueva...</a></div>
    {% endif %}
    {{ macro.listItems('complains', complains) }}
</div>

<div id="advises" class="tabcontent">
    
    {% if who['kind'] in ['OPR', 'USR', 'MNR'] %}
        <form action='/updates/new/' method="post">
            <input type="hidden" name="source" value="advise">
            <input type="hidden" name="source_id" value="{{ case['_id'] }}">
            <input class="Inline" type="date" size="8" name="date" placeholder="Fecha">
            <textarea class="Inline" name="detail" cols="60" rows="10" placeholder="Detalle"></textarea>
            <button>Actualizar</button>
        </form>
    {% endif %}

    <table>
        {% for advice in advices %}
        <tr class="ListItem">
            <td>{{ advice['date'] }}</td>
            <td>{{ advice['detail'] | safe }}</td>
        </tr>
        {% endfor %}
    </table>
</div>

<div id="docs" class="tabcontent">

    <table>
        {% for dr in docrels %}
	  <tr class="ListItem">
              <td>{{ dr['date'] }}</td>
	      <td>
		<a href="/docs/{{ dr['_id'] }}">{{ dr['title'] }}</a>
              </td>
	     </tr>
        {% endfor %}
    </table>

    {% if who['kind'] in ['OPR', 'USR', 'MNR'] %}

    <form action="/docrels/newdoc/" method="post" enctype="multipart/form-data">
        <input class="TextInput" name="title" placeholder="Título del documento"
            required>
        <input class="TextInput" name="file" type="file" required>
        <input type="hidden" name="prefix" value="{{ case['title'] }}">
        <input type="hidden" name="source" value="case">
        <input type="hidden" name="source_id" value="{{ case['_id'] }}">
        <button>Enviar</button>
    </form>

    {% endif %}
 
</div>

<script src="{{ url_for('static', filename='tabs.js') }}"></script>

{% endblock %}
